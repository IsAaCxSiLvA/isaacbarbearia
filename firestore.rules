rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Regra padrão: negar tudo
    match /{document=**} {
      allow read, write: if false;
    }

    // Coleção de avaliações (feedback público)
    match /avaliacoes/{document=**} {
      // Qualquer um pode ler
      allow read: if true;
      
      // Apenas usuários autenticados podem criar
      allow create: if request.auth != null 
        && request.auth.token.email != null
        && hasAtMostOneReview(request.auth.token.email);
      
      // Usuário só pode deletar seu próprio feedback
      allow delete: if request.auth != null 
        && request.auth.token.email == resource.data.email;
      
      // Usuário só pode editar seu próprio feedback
      allow update: if request.auth != null 
        && request.auth.token.email == resource.data.email;
    }

    // Coleção de profissionais (apenas admin edita)
    match /profissionais/{document=**} {
      // Qualquer um pode ler
      allow read: if true;
      
      // Apenas admin pode criar/editar/deletar
      allow create, update, delete: if isAdmin();
    }

    // Coleção de parceiros (apenas admin edita)
    match /parceiros/{document=**} {
      // Qualquer um pode ler
      allow read: if true;
      
      // Apenas admin pode criar/editar/deletar
      allow create, update, delete: if isAdmin();
    }

    // Coleção de participações (apenas admin edita)
    match /participacoes/{document=**} {
      // Qualquer um pode ler
      allow read: if true;
      
      // Apenas admin pode criar/editar/deletar
      allow create, update, delete: if isAdmin();
    }

    // Função para verificar se é admin
    function isAdmin() {
      return request.auth != null 
        && request.auth.token.email == 'admin@isaacbarbearia.com';
    }

    // Função para verificar se usuário não tem mais de uma avaliação
    function hasAtMostOneReview(email) {
      return get(/databases/$(database)/documents/avaliacoes/__count__).data.countByEmail[email] < 1;
    }
  }
}
